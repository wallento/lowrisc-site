<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>Running on the FPGA &middot; lowRISC</title>
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="http://wallento.github.io/lowrisc-site/libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="http://wallento.github.io/lowrisc-site/css/liquorice.css" />
        <link rel="shortcut icon" href="http://wallento.github.io/lowrisc-site/favicon.ico" />
        <link rel="alternate" href="http://wallento.github.io/lowrisc-site/index.xml" type="application/rss+xml" title="lowRISC" />
        <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-53520714-1', 'auto');
        ga('send', 'pageview');
      </script>
  </head>
    <body class="li-body">

<header class="li-page-header">
  <div class="li-header-top">
  </div>
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                
                <a href="http://wallento.github.io/lowrisc-site"><img src="http://wallento.github.io/lowrisc-site/img/lowrisc_header_logo.png"/></a></div>
                <div class="li-menu li-left">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                            <li><a href="/lowrisc-site/"> Home </a></li>
                        
                            <li><a href="/lowrisc-site/about/"> About </a></li>
                        
                            <li><a href="/lowrisc-site/faq/"> FAQ </a></li>
                        
                            <li><a href="/lowrisc-site/docs/"> Docs </a></li>
                        
                            <li><a href="/lowrisc-site/community/"> Community </a></li>
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                        <li><a href="/lowrisc-site/"> Home </a></li>
                    
                        <li><a href="/lowrisc-site/about/"> About </a></li>
                    
                        <li><a href="/lowrisc-site/faq/"> FAQ </a></li>
                    
                        <li><a href="/lowrisc-site/docs/"> Docs </a></li>
                    
                        <li><a href="/lowrisc-site/community/"> Community </a></li>
                    
                </ul>
            </div>
        </div>
    </div>
</header>









    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                
                  <p>
                    <a href="http://wallento.github.io/lowrisc-site/docs/debug-v0.3/walkthrough/">â‡¡ Debug walkthrough</a>
                  </p>
                
                    <header class="li-article-header">
                        <h1 class="li-article-title">Running on the FPGA</h1>
                        <span class="li-article-taxonomies">
                            

                            
                        </span>
                        
                        
                    </header>
                    <section>
                        

<p>In this final step, we want to test the debug on the FPGA board. The
debug system will use the UART connection at 3 MBaud to communicate
with the debug system.</p>

<h2 id="run-the-standalone-fpga:2b37e9ffd044e2f81b36b8d798aa8a19">Run the standalone FPGA</h2>

<p>You need two download two files:</p>

<ul>
<li><a href="https://github.com/lowRISC/lowrisc-chip/releases/download/v0.3/nexys4ddr_fpga_standalone.bit">nexys4ddr_fpga_standalone.bit</a>:
FPGA bitstream</li>
<li><a href="https://github.com/lowRISC/lowrisc-chip/releases/download/v0.3/boot.bin">boot.bin</a>:
Linux, Busybox and bootloader packaged in one image.</li>
</ul>

<p>Download and write the bitstream:</p>

<pre><code>curl -L https://github.com/lowRISC/lowrisc-chip/releases/download/v0.3/nexys4ddr_fpga_standalone.bit &gt; nexys4ddr_fpga_standalone.bit
curl -L https://github.com/lowRISC/lowrisc-chip/releases/download/v0.3/boot.bin &gt; boot.bin

vivado -mode batch -source $TOP/fpga/common/script/program.tcl -tclargs &quot;xc7a100t_0&quot; nexys4ddr_fpga_standalone.bit
</code></pre>

<p>Now copy the binary file to the SD card. It must be a FAT32 formatted
SD card. Insert the SD card into the slot. After that connect to the
system using the debug daemon:</p>

<pre><code>opensocdebugd uart device=/dev/ttyUSB0 speed=3000000
</code></pre>

<p>Then connect with the CLI in another terminal and boot Linux:</p>

<pre><code>osd-cli
&gt; terminal 2
&gt; reset
</code></pre>

<p>Now Linux should boot and you can interact with the terminal! In case
you experience issues with the boot procedure, try to reset again or
close the debug connection and try a hard reset of the board.</p>

<h2 id="run-the-fpga-with-debug-initialization:2b37e9ffd044e2f81b36b8d798aa8a19">Run the FPGA with debug initialization</h2>

<p>To save the procedure to move the SD card from board to computer for
each change, it is also possible to load the image directly to RAM
from the debug system.</p>

<p>For that we currently have a different bootloader, that simply jumps
to DDR. You can again download the pre-built bitstream and program the
FPGA:</p>

<pre><code>curl -L https://github.com/lowRISC/lowrisc-chip/releases/download/v0.3/nexys4ddr_fpga_debug.bit &gt; nexys4ddr_fpga_debug.bit
vivado -mode batch -source $TOP/fpga/common/script/program.tcl -tclargs &quot;xc7a100t_0&quot; nexys4ddr_fpga_debug.bit
</code></pre>

<p>Now you can connect the daemon again and load the binary from the CLI:</p>

<pre><code>osd-cli
&gt; reset -halt
&gt; terminal 2
&gt; mem loadelf boot.bin 3
&gt; start
</code></pre>

<p>The terminal should again boot Linux. To update the image simply
perform the same action again.</p>

<h2 id="build-bitstream-and-linux-image:2b37e9ffd044e2f81b36b8d798aa8a19">Build bitstream and Linux image</h2>

<h3 id="generate-the-bitstream:2b37e9ffd044e2f81b36b8d798aa8a19">Generate the bitstream</h3>

<p>To generate a bitstream change to the FPGA directory and use <code>make</code> to
build it:</p>

<pre><code>cd $TOP/fpga/board/nexys4_ddr
make bitstream
</code></pre>

<p>This will take some time (20-60 minutes depending on your
computer).</p>

<h3 id="program-the-fpga:2b37e9ffd044e2f81b36b8d798aa8a19">Program the FPGA</h3>

<p>Next, turn on the FPGA board and connect the USB cable. Now you
download the bitstream to the FPGA:</p>

<pre><code>make program
</code></pre>

<h3 id="build-linux:2b37e9ffd044e2f81b36b8d798aa8a19">Build Linux</h3>

<pre><code>cd $TOP/riscv-tools
curl https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.1.25.tar.xz| tar -xJ
curl -L http://busybox.net/downloads/busybox-1.21.1.tar.bz2| tar -xj
cd linux-4.1.25
git init
git remote add origin https://github.com/lowrisc/riscv-linux.git
git fetch
git checkout -f -t origin/debug-v0.3

# then actually just go to any directory
$TOP/riscv-tools/make_root.sh
# it will generate boot.bin and copy it there
</code></pre>

<h3 id="bootloader-variants:2b37e9ffd044e2f81b36b8d798aa8a19">Bootloader variants</h3>

<p>You can update the bootloader in the bitstream image. Simply run</p>

<pre><code>make boot
</code></pre>

<p>to generate
<code>lowrisc-chip-imp/lowrisc-chip-imp.runs/impl_1/chip_top_new.bit</code> with
the bootloader that boots from SD.</p>

<p>If you instead want to use the debug bootloader where you initialize
the DDR via the debug system, run:</p>

<pre><code>make jump
</code></pre>

<p>This will generate
<code>lowrisc-chip-imp/lowrisc-chip-imp.runs/impl_1/chip_top_new.bit</code> with
that bootloader.</p>

                    </section>
                </article>

        </div>
    </div>
    
    <div class="row li-pagination">
      <div class="eight columns">
        <div class="li-pagination-previous">
          &nbsp;
          
          Previous<br />
          &nbsp;
          <a href="http://wallento.github.io/lowrisc-site/docs/debug-v0.3/debugsession/"> A debug session</a>
          
        </div>
      </div>
      <div class="eight columns">
        <div class="li-pagination-next">
          &nbsp;
          
          Next<br />
          &nbsp;
          <a href="http://wallento.github.io/lowrisc-site/docs/debug-v0.3/release/"> Release notes</a>
          
        </div>
      </div>
    </div>
    


                

            <div id="disqus_thread"></div>
            <script type="text/javascript">
                 
                var disqus_shortname = 'lowrisc'; 
                var disqus_identifier = "/" + "lowrisc-site/docs/debug-v0.3/fpga";
                var disqus_title = "Running on the FPGA";
                var disqus_url = "http://www.lowrisc.org" + "lowrisc-site/docs/debug-v0.3/fpga";

                 
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
            </div>
            

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    </script>
    </body>
</html>

